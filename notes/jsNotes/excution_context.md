# 실행 컨텍스트(Execution Context)

실행 컨텍스트는 자바스크립트의 동작 원리를 담고 있는 핵심 개념이다.

## 자바스크립트 소스코드

### 소스코드의 타입

ECMAScript 사양에서 소스코드는 4가지 타입으로 구분되며, 소스코드 타입에 따라 실행 컨텍스트를 생성하는 과정 및 관리 내용이 상이하다.

1. 전역 코드 : 전역 영역에 존재하는 소스코드
2. 함수 코드 : 함수 내부에 존재하는 소스코드
3. eval 코드 : 빌트인 전역 함수 `eval` 함수에 인수로 전달되어 실행되는 소스코드
4. 모듈 코드 : 모듈 내부에 존재하는 소스코드

### 소스코드의 평가와 실행

자바스크립트 엔진은 2개의 과정, 즉 '소스코드의 평가'와 '소스코드의 실행'을 거쳐 소스코드를 처리한다.

#### 소스코드의 평가

1. 실행 컨텍스트 생성
2. 변수, 함수 등의 선언문 실행
3. 실행 컨텍스트가 관리하는 렉시컬 환경에 변수, 함수 등을 등록(메모리 할당)

#### 소스코드의 실행

선언문을 제외한 소스코드의 순차적 실행(런타임 시작)

1. 변수나 함수의 참조를 실행 컨텍스트가 관리하는 스코프에서 검색하여 취득
2. 소스코드의 실행 결과는 실행 컨텍스트가 관리하는 렉시컬 환경에 저장

#### 예시

- `var`

```javascript
var x;
x = 1;
```

1. 소스코드의 평가
   1. 실행 컨텍스트 생성
   2. `var` 선언문 실행
   3. 변수 `x`가 실행 컨텍스트가 관리하는 렉시컬 환경에 등록되고, `undefined`로 초기화된다.
2. 소스코드의 실행
   1. 소스코드의 순차적 실행
   2. 실행 컨텍스트가 관리하는 스코프에서 `x` 변수를 찾고, 새로운 값 `1`을 할당한다.

- `let`

```javascript
let x;
x = 1;
```

1. 소스코드의 평가
   1. 실행 컨텍스트 생성
   2. `let` 선언문 실행
   3. 변수 `x`가 스코프에 등록되기는 하지만, 값이 초기화되지는 않는다. 즉 `let`, `const`로 선언한 변수는 소스코드 평가 단계에서 스코프의 TDZ(Temporal Dead Zone)에 위치하게 되며, 소스코드 실행 단계에서 값이 할당되기 이전에 참조하면 참조 에러가 발생한다.
2. 소스코드의 실행
   1. 소스코드의 순차적 실행
   2. 실행 컨텍스트가 관리하는 스코프에서 `x` 변수를 찾고, 새로운 값 `1`을 할당한다.

## 실행 컨텍스트의 역할

코드가 실행되려면 다음과 같이 스코프, 식별자, 코드 실행 순서 등의 관리가 필요하다.

1. 선언에 의해 생성된 모든 식별자를 스코프를 구분하여 등록하고 상태 변화를 지속적으로 관리할 수 있어야 한다.
2. 스코프는 중첩 관계에 의해 스코프 체인을 형성해야 한다.
3. 현재 실행 중인 코드의 실행 순서를 변경할 수 있어야 하며, 다시 되돌아갈 수도 있어야 한다.

이 모든 것을 관리하는 것이 바로 **실행 컨텍스트**이다. 즉 실행 컨텍스트는 **식별자를 등록하고 관리하는 스코프와 코드 실행 순서의 관리 로직**이다. 이때 실행 컨텍스트의 **렉시컬 환경**이 식별자와 스코프를 관리하고, **실행 컨텍스트 스택**이 코드 실행 순서를 관리한다.

### 실행 컨텍스트 스택

```javascript
const x = 1;

function foo() {
  const y = 2;

  function bar() {
    const z = 3;
    console.log(x + y + z);
  }

  bar();
}

foo();
```

자바스크립트 엔진은 먼저 전역 코드를 평가하여 전역 실행 컨텍스트를 생성한다. 그리고 함수가 호출되면 함수 코드를 평가하여 함수 실행 컨텍스트를 생성한다. 이때 생성된 실행 컨텍스트는 스택 자료구조로 관리되며, 이를 **실행 컨텍스트 스택**이라 한다.

1. 전역 코드의 평가와 실행
1. 전역 실행 컨텍스트를 생성하여 실행 컨텍스트 스택에 푸시
1. `x`, `foo` 등록
1. 전역 코드 실행
1. `x` 값 할당, `foo` 함수 호출
1. `foo` 함수 코드의 평가와 실행
1. `foo` 호출 시 전역 코드 실행 중단, 코드 제어권이 `foo` 함수 내부로 이동
1. `foo` 함수 실행 컨텍스트를 생성하여 실행 컨텍스트 스택에 푸시
1. `y`, `bar` 등록
1. `foo` 함수 코드 실행
1. `y` 값 할당, `bar` 함수 호출
1. `bar` 함수 코드의 평가와 실행
1. `bar` 호출 시 `foo` 함수 코드 실행 중단, 코드 제어권이 `bar` 함수 내부로 이동
1. `bar` 함수 실행 컨텍스트 생성하여 실행 컨텍스트 스택에 푸시
1. `z` 등록
1. `bar` 함수 코드 실행
1. `z` 값 할당, `console.log` 호출
1. `console.log` 실행
1. `bar` 함수 실행 종료
1. `foo` 함수 코드로 복귀
   1. `bar` 함수 종료, 코드 제어권이 `foo` 함수로 이동
   2. `bar` 함수 실행 컨텍스트를 실행 컨텍스트 스택에서 팝
   3. `foo`에서 더 실행할 코드가 없으므로 `foo` 함수 실행 종료
1. 전역 코드로 복귀
   1. `foo` 함수 종료, 코드 제어권이 전역 코드로 이동
   2. `foo` 함수 실행 컨텍스트를 실행 컨텍스트 스택에서 팝
   3. 전역에서 더 실행할 코드가 없으므로 전역 실행 컨텍스트를 실행 컨텍스트 스택에서 팝

이처럼 실행 컨텍스트 스택은 코드 실행 순서를 관리한다. 실행 컨텍스트 스택 최상위에 존재하는 실행 컨텍스트는 언제나 현재 **실행 중인 실행 컨텍스트**(running execution context)이다.

### 렉시컬 환경

렉시컬 환경은 식별자와 식별자에 바인딩된 값, 그리고 상위 스코프에 대한 참조를 기록하는 자료구조로, 실행 컨텍스트를 구성하는 컴포넌트이다.

![lexical environment example](https://github.com/WilleLee/docs/blob/main/assets/lexical_environmen_ex_image.jpeg?raw=true)

렉시컬 환경은 `EnvironmentRecord`와 `OuterLexicalEnvironmentReference`의 두 가지 컴포넌트로 구성된다.

1. 환경 레코드 : 스코프에 포함된 식별자를 등록하고, 등록된 식별자에 바인딩된 값을 관리하는 저장소이다.
2. 외부 렉시컬 환경에 대한 참조 : 상위 스코프, 즉 외부 상위 코드의 렉시컬 환경을 가리킨다.
